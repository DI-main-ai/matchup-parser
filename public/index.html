<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matchup Parser</title>
<style>
  :root { color-scheme: dark light; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #0b0f14; color: #dbe2ea; }
  header { padding: 16px 20px; border-bottom: 1px solid #1c2633; background: #0e141b; position: sticky; top: 0; }
  h1 { margin: 0; font-size: 18px; }
  main { max-width: 980px; margin: 22px auto; padding: 0 16px 48px; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; align-items: start; }
  .panel { background: #101823; border: 1px solid #1c2633; border-radius: 12px; padding: 14px; }
  .drop {
    border: 2px dashed #2d3b4f; border-radius: 12px; padding: 18px; text-align: center; cursor: pointer;
    display: grid; place-items: center; min-height: 240px; transition: 120ms border-color ease;
  }
  .drop.dragover { border-color: #5aa1ff; }
  .muted { opacity: .75; font-size: 13px; }
  .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
  button {
    background: #1a2332; border: 1px solid #2b3a52; color: #e6eef8; border-radius: 10px;
    padding: 10px 14px; cursor: pointer; font-weight: 600;
  }
  button:disabled { opacity: .5; cursor: not-allowed; }
  input[type=file] { display: none; }
  img.preview { max-width: 100%; border-radius: 10px; border: 1px solid #1c2633; }
  pre { margin: 0; white-space: pre-wrap; word-break: break-word; }
  .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  .table th, .table td { padding: 8px 10px; border-bottom: 1px solid #1c2633; text-align: left; }
  .ok { color: #85f0a8; } .bad { color: #ff8f8f; }
</style>

<header><h1>Matchup Parser</h1></header>
<main>
  <div class="row">
    <section class="panel">
      <label for="weekInput">Week:</label>
      <input type="number" id="weekInput" min="1" max="18" placeholder="Enter week number" />
      <label id="drop" class="drop">
        <div>
          <div style="font-size:15px;font-weight:700">Drag & drop a screenshot here</div>
          <div class="muted" style="margin-top:6px">…or click to choose a file, or paste (Ctrl/Cmd+V)</div>
        </div>
        <input id="file" type="file" accept="image/*" />
      </label>
      <div class="actions">
        <button id="btnUpload" disabled>Upload & Parse</button>
        <button id="btnClear" disabled>Clear</button>
      </div>
      <div id="previewWrap" style="margin-top:12px; display:none">
        <img id="preview" class="preview" alt="preview"/>
      </div>
    </section>

    <section class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div>API response</div>
        <div class="actions" style="margin:0">
          <button id="btnCopyJson" disabled>Copy JSON</button>
          <button id="btnCopyTSV" disabled>Copy TSV</button>
        </div>
      </div>
      <div id="status" class="muted" style="margin:8px 0 12px">Ready</div>
      <pre id="output" style="min-height:220px"></pre>
      <div id="tableWrap" style="margin-top:12px"></div>
    </section>
  </div>
</main>

<script>
  // Adjust if you kept the .js routes:
  const ENDPOINT = "/api/parse-matchups";

  const el = s => document.querySelector(s);
  const drop = el('#drop');
  const inpFile = el('#file');
  const btnUpload = el('#btnUpload');
  const btnClear  = el('#btnClear');
  const btnCopyJson = el('#btnCopyJson');
  const btnCopyTSV  = el('#btnCopyTSV');
  const previewWrap = el('#previewWrap');
  const preview = el('#preview');
  const out = el('#output');
  const statusEl = el('#status');
  const tableWrap = el('#tableWrap');

  let currentFile = null;

  function setStatus(text, cls="") {
    statusEl.textContent = text;
    statusEl.className = "muted " + cls;
  }
  function enableActions(hasFile) {
    btnUpload.disabled = !hasFile;
    btnClear.disabled  = !hasFile;
  }
  function reset() {
    currentFile = null;
    inpFile.value = "";
    previewWrap.style.display = "none";
    preview.src = "";
    out.textContent = "";
    tableWrap.innerHTML = "";
    setStatus("Ready");
    enableActions(false);
    btnCopyJson.disabled = true;
    btnCopyTSV.disabled = true;
  }

  function loadFile(file) {
    if (!file) return;
    currentFile = file;
    const reader = new FileReader();
    reader.onload = e => {
      preview.src = e.target.result;
      previewWrap.style.display = "block";
    };
    reader.readAsDataURL(file);
    setStatus("Image selected: " + (file.name || file.type));
    enableActions(true);
  }

  // Click to select
  drop.addEventListener('click', () => inpFile.click());
  inpFile.addEventListener('change', (e) => loadFile(e.target.files[0]));

  // Drag & Drop
  ;['dragenter','dragover'].forEach(t => drop.addEventListener(t, e => {e.preventDefault(); drop.classList.add('dragover');}));
  ;['dragleave','drop'].forEach(t => drop.addEventListener(t, e => {e.preventDefault(); drop.classList.remove('dragover');}));
  drop.addEventListener('drop', e => {
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    loadFile(f);
  });

  // Paste from clipboard
  window.addEventListener('paste', e => {
    const items = e.clipboardData && e.clipboardData.items;
    if (!items) return;
    for (const it of items) {
      if (it.kind === 'file') { loadFile(it.getAsFile()); break; }
    }
  });

  btnClear.addEventListener('click', reset);

  btnUpload.addEventListener('click', async () => {
    if (!currentFile) return;
    setStatus("Uploading…");
    out.textContent = "";
    tableWrap.innerHTML = "";
    btnCopyJson.disabled = true; btnCopyTSV.disabled = true;

    const fd = new FormData();
    fd.append('file', currentFile, currentFile.name || 'screenshot.png');

    try {
      const r = await fetch(ENDPOINT, { method: 'POST', body: fd });
      const text = await r.text();
      if (!r.ok) throw new Error(text || r.statusText);
      let data;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }
      out.textContent = JSON.stringify(data, null, 2);
      setStatus("Parsed ✓", "ok");
      btnCopyJson.disabled = false;
      if (data && data.matchups && Array.isArray(data.matchups)) {
        renderTable(data.matchups);
        btnCopyTSV.disabled = false;
      }
    } catch (err) {
      setStatus("Error: " + (err.message || err), "bad");
      out.textContent = String(err);
    }
  });

  function renderTable(rows) {
    const th = ['Home','Score','Away','Score','Winner','Diff'];
    const html = [
      '<table class="table"><thead><tr>',
      ...th.map(h => `<th>${h}</th>`),
      '</tr></thead><tbody>',
      ...rows.map(r => `<tr>
        <td>${escapeHtml(r.homeTeam)}</td>
        <td>${fmtNum(r.homeScore)}</td>
        <td>${escapeHtml(r.awayTeam)}</td>
        <td>${fmtNum(r.awayScore)}</td>
        <td>${escapeHtml(r.winner)}</td>
        <td>${fmtNum(r.diff)}</td>
      </tr>`),
      '</tbody></table>'
    ].join('');
    tableWrap.innerHTML = html;
  }
  function fmtNum(n){ return (typeof n === 'number') ? n.toFixed(2) : String(n); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  btnCopyJson.addEventListener('click', async () => {
    await navigator.clipboard.writeText(out.textContent);
    setStatus("JSON copied ✓", "ok");
  });

  btnCopyTSV.addEventListener('click', async () => {
    try {
      const data = JSON.parse(out.textContent || "{}");
      const rows = (data && data.matchups) || [];
      const tsv = [
        ["Home","HomeScore","Away","AwayScore","Winner","Diff"].join('\t'),
        ...rows.map(r => [r.homeTeam, fmtNum(r.homeScore), r.awayTeam, fmtNum(r.awayScore), r.winner, fmtNum(r.diff)].join('\t'))
      ].join('\n');
      await navigator.clipboard.writeText(tsv);
      setStatus("TSV copied ✓", "ok");
    } catch {
      setStatus("Unable to copy TSV", "bad");
    }
  });

  reset();
</script>
